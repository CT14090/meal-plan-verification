{% extends "base.html" %} {% block title %}Meal Approved{% endblock %} {% block
content %}
<div class="container">
  <div class="card">
    <div class="header">
      <h1>üçΩÔ∏è Meal Plan Verification</h1>
      <div class="station">{{ station_name }}</div>
    </div>

    <div class="icon" style="font-size: 80px">‚úÖ</div>

    <div class="status-badge status-success">MEAL APPROVED</div>

    <div class="message" style="margin-top: 20px">
      <strong>Transaction Completed</strong><br />
      Have a great meal!
    </div>

    <div style="margin-top: 20px; font-size: 16px; color: #6b7280">
      Returning in <span id="countdown">3</span> seconds...
    </div>

    <div style="margin-top: 15px">
      <a href="/" class="btn btn-success" onclick="clearCountdown(); clearLookupAndReturn(); return false;">‚Üê Return Now</a>
    </div>
  </div>
</div>

<script>
  // Auto-redirect countdown (3 seconds)
  let timeLeft = 3;
  const countdownInterval = setInterval(() => {
    timeLeft--;
    const countdownEl = document.getElementById("countdown");
    if (countdownEl) {
      countdownEl.textContent = timeLeft;
    }

    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
      clearLookupAndReturn();
    }
  }, 1000);

  window.currentCountdown = countdownInterval;

  function clearCountdown() {
    if (window.currentCountdown) {
      clearInterval(window.currentCountdown);
    }
  }
  
  function clearLookupAndReturn() {
    // Clear the MUNDOWARE lookup to prevent re-detection, then return
    fetch("/api/clear-lookup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    }).then(() => {
      console.log('‚úÖ Lookup cleared after approval, returning to waiting screen');
      window.location.href = "/";
    }).catch(() => {
      // Even if clearing fails, still return
      window.location.href = "/";
    });
  }
</script>
{% endblock %}
