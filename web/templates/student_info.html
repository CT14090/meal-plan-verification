{% extends "base.html" %} 
{% block title %}Student Verification{% endblock %} 
{% block styles %}
<style>
  .student-photo {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #667eea;
    margin: 20px auto;
    display: block;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .no-photo {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 20px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px;
    color: white;
  }
  
  .meal-info {
    background: #f0f9ff;
    border: 2px solid #3b82f6;
    border-radius: 12px;
    padding: 15px;
    margin: 20px 0;
    text-align: center;
  }
  
  .meal-info .current-meal {
    font-size: 24px;
    font-weight: bold;
    color: #1e40af;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="card">
    <div class="header">
      <h1>üçΩÔ∏è Meal Plan Verification</h1>
      <div class="station">{{ station_name }}</div>
    </div>

    <div id="photo-container">
      <div class="no-photo">üë§</div>
    </div>

    <div class="student-info">
      <h2 id="student-name">Loading...</h2>

      <div class="detail">
        <span>Student ID:</span>
        <strong id="student-id">---</strong>
      </div>

      <div class="detail">
        <span>Grade:</span>
        <strong id="grade">---</strong>
      </div>

      <div class="detail">
        <span>Meal Plan:</span>
        <strong id="meal-plan">---</strong>
      </div>

      <div class="detail">
        <span>Daily Limit:</span>
        <strong id="daily-limit">---</strong>
      </div>

      <div class="usage-bar" id="usage-bar">
        <div class="usage-bar-fill" id="usage-fill">0 / 0 used</div>
      </div>

      <div id="meal-info" class="meal-info" style="display: none;">
        <div class="current-meal" id="current-meal-type">üçΩÔ∏è Lunch Service</div>
        <div style="color: #6b7280; margin-top: 5px;">Auto-detected based on current time</div>
      </div>

      <div id="eligibility-status" class="status-badge" style="margin: 15px 0"></div>
      <div id="action-buttons" style="margin-top: 15px"></div>
    </div>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const studentId = urlParams.get("student");
  let studentData = null;
  let detectedMealType = null;

  if (studentId) {
    loadStudent(studentId);
  } else {
    window.location.href = "/";
  }

  function loadStudent(id) {
    fetch("/api/manual-lookup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ student_id: id }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          studentData = data.student;
          displayStudent(data.student, data.eligibility_by_type);
        } else {
          document.getElementById("student-name").textContent = "Student Not Found";
          document.getElementById("eligibility-status").className = "status-badge status-error";
          document.getElementById("eligibility-status").textContent = "‚ùå " + data.message;
          setTimeout(() => { clearLookupAndReturn(); }, 3000);
        }
      })
      .catch(() => {
        document.getElementById("student-name").textContent = "Error";
        document.getElementById("eligibility-status").className = "status-badge status-error";
        document.getElementById("eligibility-status").textContent = "‚ùå System Error";
        setTimeout(() => { clearLookupAndReturn(); }, 3000);
      });
  }

  function displayStudent(student, eligibilityByType) {
    const photoContainer = document.getElementById("photo-container");
    if (student.photo_filename) {
      photoContainer.innerHTML = '<img src="/static/photos/' + student.photo_filename + '" alt="' + student.student_name + '" class="student-photo">';
    }

    document.getElementById("student-name").textContent = student.student_name;
    document.getElementById("student-id").textContent = student.student_id;
    document.getElementById("grade").textContent = student.grade_level;
    document.getElementById("meal-plan").textContent = student.meal_plan_type;
    document.getElementById("daily-limit").textContent = student.daily_meal_limit + " meals";

    for (const [mealType, eligibility] of Object.entries(eligibilityByType)) {
      if (eligibility.detected_meal_type) {
        detectedMealType = mealType;
        break;
      }
    }

    if (detectedMealType) {
      const mealIcons = { 'Breakfast': 'üåÖ', 'Lunch': 'üçΩÔ∏è', 'Snack': 'üçø' };
      document.getElementById("meal-info").style.display = "block";
      document.getElementById("current-meal-type").innerHTML = (mealIcons[detectedMealType] || 'üçΩÔ∏è') + ' ' + detectedMealType + ' Service';
    }

    const eligibility = eligibilityByType[detectedMealType] || Object.values(eligibilityByType)[0];
    const totalUsed = eligibility.meals_used || 0;
    const usagePct = (totalUsed / student.daily_meal_limit) * 100;
    const usageFill = document.getElementById("usage-fill");
    usageFill.style.width = usagePct + "%";
    usageFill.textContent = totalUsed + " / " + student.daily_meal_limit + " used";
    if (usagePct >= 100) usageFill.classList.add("full");

    if (eligibility.eligible) {
      document.getElementById("eligibility-status").className = "status-badge status-success";
      document.getElementById("eligibility-status").textContent = "‚úÖ ELIGIBLE FOR MEAL";
      document.getElementById("action-buttons").innerHTML = '<button onclick="approveMeal()" class="btn btn-success" id="approve-btn">‚úì APPROVE MEAL</button><a href="/" class="btn btn-secondary" onclick="clearLookupAndReturn(); return false;">‚Üê Back</a>';
    } else {
      document.getElementById("eligibility-status").className = "status-badge status-error";
      document.getElementById("eligibility-status").textContent = "‚ùå NOT ELIGIBLE";
      document.getElementById("action-buttons").innerHTML = '<div class="message" style="color: #ef4444; margin-bottom: 15px; font-size: 20px;"><strong>' + eligibility.reason + '</strong></div><div style="font-size: 16px; color: #6b7280; margin-bottom: 15px;">Returning in <span id="countdown">3</span> seconds...</div><a href="/" class="btn btn-secondary" onclick="clearCountdown(); clearLookupAndReturn(); return false;">‚Üê Return Now</a>';
      
      fetch("/api/deny-meal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ student_id: student.student_id, meal_type: detectedMealType, reason: eligibility.reason }),
      }).catch(() => {});
      
      let timeLeft = 3;
      const countdownInterval = setInterval(() => {
        timeLeft--;
        const countdownEl = document.getElementById("countdown");
        if (countdownEl) countdownEl.textContent = timeLeft;
        if (timeLeft <= 0) { clearInterval(countdownInterval); clearLookupAndReturn(); }
      }, 1000);
      window.currentCountdown = countdownInterval;
    }
  }

  function approveMeal() {
    const approveBtn = document.getElementById('approve-btn');
    approveBtn.disabled = true;
    approveBtn.textContent = "Processing...";
    
    fetch("/api/approve-meal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ student_id: studentData.student_id, meal_type: detectedMealType }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          window.location.href = '/approved?student=' + studentData.student_id;
        } else {
          alert("‚ùå Error: " + data.message);
          approveBtn.disabled = false;
          approveBtn.textContent = "‚úì APPROVE MEAL";
        }
      })
      .catch((error) => {
        alert("‚ùå Error: " + error.message);
        approveBtn.disabled = false;
        approveBtn.textContent = "‚úì APPROVE MEAL";
      });
  }

  function clearCountdown() {
    if (window.currentCountdown) clearInterval(window.currentCountdown);
  }
  
  function clearLookupAndReturn() {
    fetch("/api/clear-lookup", { method: "POST", headers: { "Content-Type": "application/json" } })
      .then(() => { window.location.href = "/"; })
      .catch(() => { window.location.href = "/"; });
  }
</script>
{% endblock %}