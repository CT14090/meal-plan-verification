{% extends "base.html" %} 
{% block title %}Student Verification{% endblock %} 
{% block styles %}
<style>
  .student-photo {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #667eea;
    margin: 20px auto;
    display: block;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  .no-photo {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 20px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px;
    color: white;
  }
  
  .tokens-container {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin: 40px 0;
    flex-wrap: wrap;
  }
  
  .token {
    width: 160px;
    height: 160px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    border: 5px solid;
    font-weight: bold;
    position: relative;
  }
  
  .token:hover:not(.token-used):not(.token-unavailable) {
    transform: scale(1.15);
    box-shadow: 0 12px 30px rgba(0,0,0,0.4);
  }
  
  .token-available {
    background: linear-gradient(135deg, #10b981, #059669);
    border-color: #047857;
    color: white;
  }
  
  .token-used {
    background: #fee2e2;
    border-color: #dc2626;
    color: #991b1b;
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .token-unavailable {
    background: #f3f4f6;
    border-color: #9ca3af;
    color: #6b7280;
    cursor: not-allowed;
    opacity: 0.4;
  }
  
  .token-icon {
    font-size: 56px;
    margin-bottom: 10px;
  }
  
  .token-label {
    font-size: 18px;
    font-weight: bold;
  }
  
  .token-status {
    font-size: 13px;
    margin-top: 6px;
    opacity: 0.9;
  }

  .processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .processing-overlay.active {
    display: flex;
  }

  .processing-message {
    background: white;
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="card">
    <div class="header">
      <h1>üçΩÔ∏è Meal Plan Verification</h1>
      <div class="station">{{ station_name }}</div>
    </div>

    <div id="photo-container">
      <div class="no-photo">üë§</div>
    </div>

    <div class="student-info">
      <h2 id="student-name">Loading...</h2>

      <div class="detail">
        <span>Student ID:</span>
        <strong id="student-id">---</strong>
      </div>

      <div class="detail">
        <span>Grade:</span>
        <strong id="grade">---</strong>
      </div>

      <div class="detail">
        <span>Meal Plan:</span>
        <strong id="meal-plan">---</strong>
      </div>

      <div class="detail">
        <span>Daily Limit:</span>
        <strong id="daily-limit">---</strong>
      </div>

      <div class="usage-bar" id="usage-bar">
        <div class="usage-bar-fill" id="usage-fill">0 / 0 used</div>
      </div>

      <!-- TOKEN SYSTEM -->
      <div class="tokens-container" id="tokens-container"></div>

      <div id="eligibility-status" class="status-badge" style="margin: 15px 0; display: none;"></div>
      
      <div id="action-buttons" style="margin-top: 25px">
        <a href="/" class="btn btn-secondary" onclick="clearLookupAndReturn(); return false;">‚Üê Back</a>
      </div>
    </div>
  </div>
</div>

<!-- Processing overlay -->
<div class="processing-overlay" id="processing-overlay">
  <div class="processing-message" id="processing-message">
    Processing...
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const studentId = urlParams.get("student");
  let studentData = null;
  let eligibilityData = null;
  let allowedMealTypes = [];

  const MEAL_ICONS = {
    'Breakfast': 'üåÖ',
    'Lunch': 'üçΩÔ∏è',
    'Snack': 'üçø'
  };

  if (studentId) {
    loadStudent(studentId);
  } else {
    window.location.href = "/";
  }

  function loadStudent(id) {
    fetch("/api/manual-lookup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ student_id: id }),
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          studentData = data.student;
          eligibilityData = data.eligibility_by_type;
          allowedMealTypes = data.allowed_meal_types || [];
          displayStudent(data.student, data.eligibility_by_type);
        } else {
          showError("Student Not Found", data.message);
        }
      })
      .catch(() => showError("Error", "System Error"));
  }

  function displayStudent(student, eligibilityByType) {
    const photoContainer = document.getElementById("photo-container");
    if (student.photo_filename) {
      photoContainer.innerHTML = `<img src="/static/photos/${student.photo_filename}" class="student-photo">`;
    }

    document.getElementById("student-name").textContent = student.student_name;
    document.getElementById("student-id").textContent = student.student_id;
    document.getElementById("grade").textContent = student.grade_level;
    document.getElementById("meal-plan").textContent = student.meal_plan_type;
    document.getElementById("daily-limit").textContent = student.daily_meal_limit + " meals";

    // Update usage bar
    const firstEligibility = Object.values(eligibilityByType)[0];
    const totalUsed = firstEligibility.meals_used || 0;
    const usagePct = (totalUsed / student.daily_meal_limit) * 100;
    const usageFill = document.getElementById("usage-fill");
    usageFill.style.width = usagePct + "%";
    usageFill.textContent = `${totalUsed} / ${student.daily_meal_limit} used`;
    if (usagePct >= 100) usageFill.classList.add("full");

    // Render tokens
    renderTokens(eligibilityByType);
  }

  function renderTokens(eligibilityByType) {
    const container = document.getElementById("tokens-container");
    container.innerHTML = '';

    const mealTypes = ['Breakfast', 'Lunch', 'Snack'];

    mealTypes.forEach(mealType => {
      const eligibility = eligibilityByType[mealType];
      const isAllowed = allowedMealTypes.includes(mealType);
      const isUsed = eligibility.meal_type_status && 
                     ((mealType === 'Breakfast' && eligibility.meal_type_status.breakfast_used) ||
                      (mealType === 'Lunch' && eligibility.meal_type_status.lunch_used) ||
                      (mealType === 'Snack' && eligibility.meal_type_status.snack_used));
      
      const token = document.createElement('div');
      token.className = 'token';
      
      let tokenClass = '';
      let statusText = '';
      let clickable = false;

      if (!isAllowed) {
        tokenClass = 'token-unavailable';
        statusText = 'Not in plan';
      } else if (isUsed) {
        tokenClass = 'token-used';
        statusText = 'Used today';
      } else {
        tokenClass = 'token-available';
        statusText = 'Click to approve';
        clickable = true;
      }

      token.classList.add(tokenClass);
      token.innerHTML = `
        <div class="token-icon">${MEAL_ICONS[mealType]}</div>
        <div class="token-label">${mealType}</div>
        <div class="token-status">${statusText}</div>
      `;

      if (clickable) {
        token.onclick = () => approveMealToken(mealType, eligibility);
      }

      container.appendChild(token);
    });
  }

  function approveMealToken(mealType, eligibility) {
    // Check eligibility first
    if (!eligibility.eligible) {
      showDenialMessage(eligibility.reason, mealType);
      return;
    }

    // Show processing overlay
    document.getElementById("processing-message").textContent = `Approving ${mealType}...`;
    document.getElementById("processing-overlay").classList.add("active");
    
    fetch("/api/approve-meal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        student_id: studentData.student_id, 
        meal_type: mealType 
      }),
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // Show success and redirect
          document.getElementById("processing-message").innerHTML = 
            `‚úÖ<br>${mealType} Approved!`;
          setTimeout(() => {
            window.location.href = `/approved?student=${studentData.student_id}`;
          }, 1000);
        } else {
          document.getElementById("processing-overlay").classList.remove("active");
          alert("‚ùå Error: " + data.message);
        }
      })
      .catch(err => {
        document.getElementById("processing-overlay").classList.remove("active");
        alert("‚ùå Error: " + err.message);
      });
  }

  function showDenialMessage(reason, mealType) {
    document.getElementById("eligibility-status").style.display = "block";
    document.getElementById("eligibility-status").className = "status-badge status-error";
    document.getElementById("eligibility-status").textContent = "‚ùå " + reason;
    
    logDenial(studentData.student_id, reason, mealType);
    
    // Auto-return after 3 seconds
    let timeLeft = 3;
    const countdownDiv = document.createElement('div');
    countdownDiv.style.cssText = 'font-size: 16px; color: #6b7280; margin-top: 15px;';
    countdownDiv.innerHTML = `Returning in <span id="countdown">${timeLeft}</span> seconds...`;
    document.getElementById("action-buttons").insertBefore(
      countdownDiv, 
      document.getElementById("action-buttons").firstChild
    );

    const interval = setInterval(() => {
      timeLeft--;
      const el = document.getElementById("countdown");
      if (el) el.textContent = timeLeft;
      if (timeLeft <= 0) {
        clearInterval(interval);
        clearLookupAndReturn();
      }
    }, 1000);
    window.currentCountdown = interval;
  }

  function logDenial(studentId, reason, mealType) {
    fetch("/api/deny-meal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        student_id: studentId, 
        meal_type: mealType, 
        reason: reason 
      }),
    }).catch(() => {});
  }

  function showError(title, message) {
    document.getElementById("student-name").textContent = title;
    document.getElementById("eligibility-status").style.display = "block";
    document.getElementById("eligibility-status").className = "status-badge status-error";
    document.getElementById("eligibility-status").textContent = "‚ùå " + message;
    setTimeout(() => clearLookupAndReturn(), 3000);
  }
  
  function clearLookupAndReturn() {
    fetch("/api/clear-lookup", { 
      method: "POST", 
      headers: { "Content-Type": "application/json" } 
    })
      .then(() => window.location.href = "/")
      .catch(() => window.location.href = "/");
  }
</script>
{% endblock %}
