{% extends "base.html" %} {% block title %}Student Verification{% endblock %} {%
block content %}
<div class="container">
  <div class="card">
    <div class="header">
      <h1>üçΩÔ∏è Meal Plan Verification</h1>
      <div class="station">{{ station_name }}</div>
    </div>

    <div class="icon">ÔøΩÔøΩ</div>

    <div class="student-info">
      <h2 id="student-name">Loading...</h2>

      <div class="detail">
        <span>Student ID:</span>
        <strong id="student-id">---</strong>
      </div>

      <div class="detail">
        <span>Grade:</span>
        <strong id="grade">---</strong>
      </div>

      <div class="detail">
        <span>Meal Plan:</span>
        <strong id="meal-plan">---</strong>
      </div>

      <div class="detail">
        <span>Daily Limit:</span>
        <strong id="daily-limit">---</strong>
      </div>

      <div class="usage-bar" id="usage-bar">
        <div class="usage-bar-fill" id="usage-fill">0 / 0 used</div>
      </div>

      <div
        id="eligibility-status"
        class="status-badge"
        style="margin: 15px 0"
      ></div>

      <div id="action-buttons" style="margin-top: 15px"></div>
    </div>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const studentId = urlParams.get("student");

  if (studentId) {
    loadStudent(studentId);
  } else {
    window.location.href = "/";
  }

  function loadStudent(id) {
    // Get student info but DON'T clear lookup yet
    // (lookup will be cleared when we navigate away)
    
    fetch("/api/manual-lookup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ student_id: id }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          displayStudent(data.student, data.eligibility);
        } else {
          document.getElementById("student-name").textContent =
            "Student Not Found";
          document.getElementById("eligibility-status").className =
            "status-badge status-error";
          document.getElementById("eligibility-status").textContent =
            "‚ùå " + data.message;

          // Log the denial for student not found
          logDenial(id, data.message || "Student not found");

          // Auto-return after showing error
          setTimeout(() => {
            clearLookupAndReturn();
          }, 3000);
        }
      })
      .catch((error) => {
        document.getElementById("student-name").textContent = "Error";
        document.getElementById("eligibility-status").className =
          "status-badge status-error";
        document.getElementById("eligibility-status").textContent =
          "‚ùå System Error";

        setTimeout(() => {
          clearLookupAndReturn();
        }, 3000);
      });
  }

  function displayStudent(student, eligibility) {
    document.getElementById("student-name").textContent = student.student_name;
    document.getElementById("student-id").textContent = student.student_id;
    document.getElementById("grade").textContent = student.grade_level;
    document.getElementById("meal-plan").textContent = student.meal_plan_type;
    document.getElementById("daily-limit").textContent =
      student.daily_meal_limit + " meals";

    const usagePct = (eligibility.meals_used / student.daily_meal_limit) * 100;
    const usageFill = document.getElementById("usage-fill");
    usageFill.style.width = usagePct + "%";
    usageFill.textContent =
      eligibility.meals_used + " / " + student.daily_meal_limit + " used";

    if (usagePct >= 100) {
      usageFill.classList.add("full");
    }

    const statusDiv = document.getElementById("eligibility-status");
    const buttonsDiv = document.getElementById("action-buttons");

    if (eligibility.eligible) {
      // ELIGIBLE - Only show APPROVE button
      statusDiv.className = "status-badge status-success";
      statusDiv.textContent = "‚úÖ ELIGIBLE FOR MEAL";

      buttonsDiv.innerHTML = `
            <button onclick="approveMeal('${student.student_id}')" class="btn btn-success">
                ‚úì APPROVE MEAL
            </button>
            <a href="/" class="btn btn-secondary" onclick="clearLookupAndReturn(); return false;">‚Üê Back</a>
        `;
    } else {
      // NOT ELIGIBLE - Show reason, log denial, auto-return
      statusDiv.className = "status-badge status-error";
      statusDiv.textContent = "‚ùå NOT ELIGIBLE";

      buttonsDiv.innerHTML = `
            <div class="message" style="color: #ef4444; margin-bottom: 15px; font-size: 20px;">
                <strong>${eligibility.reason}</strong>
            </div>
            <div style="font-size: 16px; color: #6b7280; margin-bottom: 15px;">
                Returning in <span id="countdown">3</span> seconds...
            </div>
            <a href="/" class="btn btn-secondary" onclick="clearCountdown(); clearLookupAndReturn(); return false;">‚Üê Return Now</a>
        `;

      // Log the denial to database (ONLY for ineligible students)
      logDenial(student.student_id, eligibility.reason);

      // Auto-redirect countdown
      let timeLeft = 3;
      const countdownInterval = setInterval(() => {
        timeLeft--;
        const countdownEl = document.getElementById("countdown");
        if (countdownEl) {
          countdownEl.textContent = timeLeft;
        }

        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          clearLookupAndReturn();
        }
      }, 1000);

      window.currentCountdown = countdownInterval;
    }
  }

  function logDenial(studentId, reason) {
    // Call the deny-meal API to log this denial in the database
    fetch("/api/deny-meal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        student_id: studentId,
        reason: reason,
      }),
    }).catch((err) => {
      console.error("Error logging denial:", err);
    });
  }

  function clearCountdown() {
    if (window.currentCountdown) {
      clearInterval(window.currentCountdown);
    }
  }
  
  function clearLookupAndReturn() {
    // Clear lookup before returning to waiting screen
    fetch("/api/clear-lookup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    }).then(() => {
      console.log('‚úÖ Lookup cleared, returning to waiting screen');
      window.location.href = "/";
    }).catch(() => {
      // Even if clearing fails, still return
      window.location.href = "/";
    });
  }

  function approveMeal(studentId) {
    // Disable the button to prevent double-clicks
    const approveBtn = event.target;
    approveBtn.disabled = true;
    approveBtn.textContent = "Processing...";
    
    fetch("/api/approve-meal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ student_id: studentId, meal_type: "Lunch" }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          console.log('‚úÖ Meal approved, navigating to approved page');
          // Navigate to approved page (lookup will be cleared there)
          window.location.href = "/approved?student=" + studentId;
        } else {
          alert("‚ùå Error: " + data.message);
          approveBtn.disabled = false;
          approveBtn.textContent = "‚úì APPROVE MEAL";
        }
      })
      .catch((error) => {
        alert("‚ùå Error approving meal: " + error.message);
        approveBtn.disabled = false;
        approveBtn.textContent = "‚úì APPROVE MEAL";
      });
  }
</script>
{% endblock %}
