{% extends "base.html" %} {% block title %}Admin Dashboard{% endblock %} {%
block styles %}
<style>
  body {
    background: #f3f4f6;
    overflow: hidden !important;
  }
  .container {
    height: 100vh;
    overflow: hidden;
  }
  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .dashboard-header {
    background: white;
    padding: 25px;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 15px;
  }
  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    position: relative;
  }
  .stat-card.updating {
    animation: pulse 0.5s ease-in-out;
  }
  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }
  .stat-value {
    font-size: 42px;
    font-weight: bold;
    margin: 8px 0;
  }
  .stat-label {
    font-size: 15px;
    opacity: 0.9;
  }
  .action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 15px;
  }
  .last-updated {
    text-align: center;
    color: #6b7280;
    font-size: 14px;
    margin-top: 10px;
  }
</style>
{% endblock %} {% block content %}
<div class="admin-container">
  <div class="dashboard-header">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      "
    >
      <h1 style="color: #1f2937; margin: 0">ğŸ“Š Admin Dashboard</h1>
      <button
        onclick="refreshStats()"
        class="btn btn-secondary"
        style="padding: 15px 30px; font-size: 18px"
      >
        ğŸ”„ Refresh Now
      </button>
    </div>
    <p style="color: #6b7280">{{ station_name }} - Real-time Statistics</p>
    <div class="last-updated" id="last-updated">Last updated: Just now</div>

    <div class="stat-grid" id="stat-grid">
      <div class="stat-card" id="card-students">
        <div class="stat-label">Total Students</div>
        <div class="stat-value" id="stat-students">{{ student_count }}</div>
      </div>
      <div class="stat-card" id="card-approved">
        <div class="stat-label">Today's Meals</div>
        <div class="stat-value" id="stat-approved">{{ stats.approved }}</div>
      </div>
      <div class="stat-card" id="card-denied">
        <div class="stat-label">Denied</div>
        <div class="stat-value" id="stat-denied">{{ stats.denied }}</div>
      </div>
      <div class="stat-card" id="card-breakfast">
        <div class="stat-label">Breakfast</div>
        <div class="stat-value" id="stat-breakfast">{{ stats.breakfast }}</div>
      </div>
      <div class="stat-card" id="card-lunch">
        <div class="stat-label">Lunch</div>
        <div class="stat-value" id="stat-lunch">{{ stats.lunch }}</div>
      </div>
      <div class="stat-card" id="card-snack">
        <div class="stat-label">Snacks</div>
        <div class="stat-value" id="stat-snack">{{ stats.snack }}</div>
      </div>
    </div>

    <div class="action-buttons">
      <a href="/" class="btn btn-success">â† Back to Touchscreen</a>
      <a href="/admin/export-students-csv" class="btn btn-secondary"
        >ğŸ“¥ Export Students CSV</a
      >
      <button
        onclick="triggerDailyReset()"
        class="btn btn-danger"
        style="background: #f59e0b"
      >
        ğŸ”„ Reset Daily Meal Counts (Testing)
      </button>
    </div>
  </div>
</div>

<script>
  // Auto-refresh stats every 60 seconds
  let refreshInterval = setInterval(refreshStats, 60000);

  function refreshStats() {
    fetch("/api/stats")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          updateStatCard("stat-approved", data.stats.approved, "card-approved");
          updateStatCard("stat-denied", data.stats.denied, "card-denied");
          updateStatCard(
            "stat-breakfast",
            data.stats.breakfast,
            "card-breakfast",
          );
          updateStatCard("stat-lunch", data.stats.lunch, "card-lunch");
          updateStatCard("stat-snack", data.stats.snack, "card-snack");

          // Update last updated time
          const now = new Date();
          const timeStr = now.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
          document.getElementById("last-updated").textContent =
            "Last updated: " + timeStr;
        }
      })
      .catch((error) => {
        console.error("Error refreshing stats:", error);
      });
  }

  function updateStatCard(elementId, newValue, cardId) {
    const element = document.getElementById(elementId);
    const card = document.getElementById(cardId);

    if (element && element.textContent !== newValue.toString()) {
      // Add pulse animation if value changed
      card.classList.add("updating");
      setTimeout(() => card.classList.remove("updating"), 500);
    }

    if (element) {
      element.textContent = newValue;
    }
  }

  function triggerDailyReset() {
    if (
      !confirm(
        "âš ï¸ This will reset ALL daily meal counts to zero.\n\nAre you sure you want to continue?\n\n(In production, this happens automatically at midnight Panama time)",
      )
    ) {
      return;
    }

    fetch("/admin/trigger-reset", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert(
            "âœ… Daily meal counts have been reset!\n\nAll students now have fresh daily allowances.",
          );
          refreshStats(); // Refresh the dashboard
        } else {
          alert("âŒ Reset failed: " + (data.message || "Unknown error"));
        }
      })
      .catch((error) => {
        alert("âŒ Error triggering reset: " + error.message);
      });
  }

  // Initial refresh on page load
  refreshStats();
</script>
{% endblock %}
