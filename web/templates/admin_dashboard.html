{% extends "base.html" %} {% block title %}Admin Dashboard{% endblock %} {%
block styles %}
<style>
  body {
    background: #f3f4f6;
    overflow-y: auto !important;
  }
  .container {
    height: auto;
    min-height: 100vh;
    padding: 40px 20px;
  }
  .admin-container {
    max-width: 1400px;
    margin: 0 auto;
  }
  .dashboard-header {
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
  }
  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  .header-row h1 {
    color: #1f2937;
    margin: 0;
    font-size: 42px;
  }
  .header-row .btn {
    padding: 15px 30px;
    font-size: 18px;
  }
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 25px;
  }
  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 16px;
    text-align: center;
    position: relative;
    transition: transform 0.2s;
  }
  .stat-card:hover {
    transform: translateY(-5px);
  }
  .stat-card.updating {
    animation: pulse 0.5s ease-in-out;
  }
  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }
  .stat-value {
    font-size: 56px;
    font-weight: bold;
    margin: 15px 0;
  }
  .stat-label {
    font-size: 18px;
    opacity: 0.95;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .action-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 25px;
  }
  .action-buttons .btn {
    padding: 15px 30px;
    font-size: 18px;
  }
  .last-updated {
    text-align: center;
    color: #6b7280;
    font-size: 14px;
    margin-top: 12px;
    font-style: italic;
  }
  .subtitle {
    color: #6b7280;
    font-size: 16px;
    margin-top: 5px;
  }
</style>
{% endblock %} {% block content %}
<div class="admin-container">
  <div class="dashboard-header">
    <div class="header-row">
      <div>
        <h1>üìä Admin Dashboard</h1>
        <p class="subtitle">{{ station_name }} - Real-time Statistics</p>
      </div>
      <button onclick="refreshStats()" class="btn btn-secondary">
        üîÑ Refresh Now
      </button>
    </div>
    <div class="last-updated" id="last-updated">Last updated: Just now</div>

    <div class="stat-grid" id="stat-grid">
      <div class="stat-card" id="card-students">
        <div class="stat-label">Total Students</div>
        <div class="stat-value" id="stat-students">{{ student_count }}</div>
      </div>
      <div class="stat-card" id="card-approved">
        <div class="stat-label">Today's Meals</div>
        <div class="stat-value" id="stat-approved">{{ stats.approved }}</div>
      </div>
      <div class="stat-card" id="card-denied">
        <div class="stat-label">Denied Today</div>
        <div class="stat-value" id="stat-denied">{{ stats.denied }}</div>
      </div>
      <div class="stat-card" id="card-breakfast">
        <div class="stat-label">Breakfast</div>
        <div class="stat-value" id="stat-breakfast">{{ stats.breakfast }}</div>
      </div>
      <div class="stat-card" id="card-lunch">
        <div class="stat-label">Lunch</div>
        <div class="stat-value" id="stat-lunch">{{ stats.lunch }}</div>
      </div>
      <div class="stat-card" id="card-snack">
        <div class="stat-label">Snacks</div>
        <div class="stat-value" id="stat-snack">{{ stats.snack }}</div>
      </div>
    </div>

    <div class="action-buttons">
      <a href="/" class="btn btn-success">‚Üê Back to Touchscreen</a>
      <a href="/admin/export-students-csv" class="btn btn-secondary"
        >üì• Export Students CSV</a
      >
      <button
        onclick="triggerDailyReset()"
        class="btn btn-danger"
        style="background: #f59e0b"
      >
        üîÑ Reset Daily Meal Counts (Testing)
      </button>
    </div>
  </div>
</div>

<script>
  // Auto-refresh stats every 60 seconds (1 minute)
  let refreshInterval = setInterval(refreshStats, 60000);

  console.log(
    "Admin dashboard loaded - auto-refresh enabled (every 60 seconds)",
  );

  function refreshStats() {
    console.log("Refreshing stats...");

    fetch("/api/stats")
      .then((response) => {
        console.log("Stats API response:", response.status);
        return response.json();
      })
      .then((data) => {
        console.log("Stats data received:", data);

        if (data.success) {
          updateStatCard("stat-approved", data.stats.approved, "card-approved");
          updateStatCard("stat-denied", data.stats.denied, "card-denied");
          updateStatCard(
            "stat-breakfast",
            data.stats.breakfast,
            "card-breakfast",
          );
          updateStatCard("stat-lunch", data.stats.lunch, "card-lunch");
          updateStatCard("stat-snack", data.stats.snack, "card-snack");

          // Update last updated time
          const now = new Date();
          const timeStr = now.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
          document.getElementById("last-updated").textContent =
            "Last updated: " + timeStr;

          console.log("Stats updated successfully");
        } else {
          console.error("Stats API returned success: false");
        }
      })
      .catch((error) => {
        console.error("Error refreshing stats:", error);
      });
  }

  function updateStatCard(elementId, newValue, cardId) {
    const element = document.getElementById(elementId);
    const card = document.getElementById(cardId);

    const oldValue = element ? element.textContent : null;

    if (element && oldValue !== newValue.toString()) {
      console.log(`${elementId}: ${oldValue} ‚Üí ${newValue}`);

      // Add pulse animation if value changed
      card.classList.add("updating");
      setTimeout(() => card.classList.remove("updating"), 500);
    }

    if (element) {
      element.textContent = newValue;
    }
  }

  function triggerDailyReset() {
    if (
      !confirm(
        "‚ö†Ô∏è This will reset ALL daily meal counts to zero.\n\nThis will also DELETE all of today's transaction records.\n\nAre you sure you want to continue?\n\n(In production, this happens automatically at midnight Panama time)",
      )
    ) {
      return;
    }

    console.log("Triggering daily reset...");

    fetch("/admin/trigger-reset", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Reset response:", data);

        if (data.success) {
          const msg =
            `‚úÖ Daily reset complete!\n\n` +
            `‚Ä¢ ${data.usage_cleared} usage records cleared\n` +
            `‚Ä¢ ${data.transactions_cleared} transaction records deleted\n\n` +
            `All students now have fresh daily allowances.\n` +
            `All stats reset to 0.`;
          alert(msg);
          refreshStats(); // Refresh the dashboard
        } else {
          alert("‚ùå Reset failed: " + (data.message || "Unknown error"));
        }
      })
      .catch((error) => {
        console.error("Reset error:", error);
        alert("‚ùå Error triggering reset: " + error.message);
      });
  }

  // Initial refresh on page load
  console.log("Loading initial stats...");
  refreshStats();
</script>
{% endblock %}
