{% extends "base.html" %} 
{% block title %}Ready to Scan - Meal Plan Verification{% endblock %} 
{% block content %}
<div class="container">
  <div class="card">
    <div class="header">
      <h1>ğŸ½ï¸ Meal Plan Verification</h1>
      <div class="station">{{ station_name }}</div>
    </div>

    <div class="icon" id="status-icon">ğŸ’³</div>

    <div class="message" id="status-message">
      <strong>READY</strong><br />
      Please scan your student ID card
    </div>

    <div style="margin-top: 30px">
      <a href="/manual" class="btn btn-secondary"> Manual Entry </a>
    </div>
  </div>
</div>
{% endblock %} 

{% block scripts %}
<script>
  const statusIcon = document.getElementById("status-icon");
  let hasNavigated = false;

  // Animate the card icon
  function animateWaiting() {
    statusIcon.style.transform = "scale(1.1)";
    setTimeout(() => {
      statusIcon.style.transform = "scale(1.0)";
    }, 500);
  }

  setInterval(animateWaiting, 2000);

  // Poll for recent card scans
  async function checkForCardScan() {
    if (hasNavigated) return;
    
    try {
      const response = await fetch('/api/check-recent-scan?t=' + Date.now());
      const data = await response.json();
      
      if (data.success && data.student_id) {
        hasNavigated = true;
        console.log('ğŸ¯ Card detected! Navigating to student:', data.student_id);
        window.location.href = `/student-info?student=${data.student_id}`;
      }
    } catch (error) {
      console.error('Error checking for scans:', error);
    }
  }
  
  // Check every 300ms for fast response
  setInterval(checkForCardScan, 300);
  
  console.log('âœ… Waiting screen ready - polling for card scans');
  
  // Start polling immediately
  checkForCardScan();
</script>
{% endblock %}
