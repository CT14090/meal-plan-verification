{% extends "base.html" %} 
{% block title %}Ready to Scan - Meal Plan Verification{% endblock %} 
{% block content %}
<div class="container">
  <div class="card">
    <div class="header">
      <h1>üçΩÔ∏è Meal Plan Verification</h1>
      <div class="station">{{ station_name }}</div>
    </div>

    <div class="icon" id="status-icon">üí≥</div>

    <div class="message" id="status-message">
      <strong>READY</strong><br />
      Please scan your student ID card
    </div>

    <div
      class="status-badge status-success"
      id="status-badge"
      style="display: none"
    >
      Waiting for card...
    </div>

    <div style="margin-top: 30px">
      <a href="/manual" class="btn btn-secondary"> Manual Entry </a>
    </div>
    
    <!-- Debug info -->
    <div style="position: fixed; bottom: 60px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; font-size: 12px; border-radius: 5px;">
      <div>Polling: <span id="poll-count">0</span></div>
      <div>Last Check: <span id="last-check">Never</span></div>
      <div>Status: <span id="poll-status">Starting...</span></div>
    </div>
  </div>
</div>
{% endblock %} 

{% block scripts %}
<script>
  const statusIcon = document.getElementById("status-icon");
  const statusMessage = document.getElementById("status-message");
  let pollCount = 0;
  let hasNavigated = false; // Prevent multiple navigations

  // Clear any stale lookups when page loads
  fetch("/api/clear-lookup", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
  }).then(() => {
    console.log('‚úÖ Cleared any stale lookups on page load');
  }).catch(err => {
    console.error('Error clearing stale lookups:', err);
  });

  // Animate the card icon
  function animateWaiting() {
    statusIcon.style.transform = "scale(1.1)";
    setTimeout(() => {
      statusIcon.style.transform = "scale(1.0)";
    }, 500);
  }

  setInterval(animateWaiting, 2000);

  // Poll for recent card scans
  async function checkForCardScan() {
    if (hasNavigated) return; // Don't poll if we're already navigating
    
    pollCount++;
    document.getElementById('poll-count').textContent = pollCount;
    document.getElementById('last-check').textContent = new Date().toLocaleTimeString();
    
    try {
      document.getElementById('poll-status').textContent = 'Checking...';
      
      const response = await fetch('/api/check-recent-scan?t=' + Date.now());
      const data = await response.json();
      
      console.log('Poll #' + pollCount + ':', data);
      
      if (data.success && data.student_id) {
        hasNavigated = true; // Prevent multiple navigations
        console.log('üéØ Card detected! Student ID:', data.student_id);
        document.getElementById('poll-status').textContent = 'CARD DETECTED!';
        document.getElementById('poll-status').style.color = '#10b981';
        
        // Navigate to student info
        console.log('Navigating to /student-info?student=' + data.student_id);
        window.location.href = `/student-info?student=${data.student_id}`;
      } else {
        document.getElementById('poll-status').textContent = 'Waiting...';
      }
    } catch (error) {
      console.error('‚ùå Error checking for scans:', error);
      document.getElementById('poll-status').textContent = 'Error: ' + error.message;
      document.getElementById('poll-status').style.color = '#ef4444';
    }
  }
  
  // Check every 300ms for card scans (faster response)
  const pollInterval = setInterval(checkForCardScan, 300);
  
  console.log('‚úÖ Waiting screen ready - polling every 300ms');
  console.log('Station:', '{{ station_name }}');
  
  // Initial check after a brief delay (let the clear-lookup finish first)
  setTimeout(checkForCardScan, 500);
</script>
{% endblock %}
