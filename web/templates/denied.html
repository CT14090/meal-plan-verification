{% extends "base.html" %} {% block title %}Meal Denied{% endblock %} {% block
content %}
<div class="container">
  <div class="card">
    <div class="header">
      <h1>üçΩÔ∏è Meal Plan Verification</h1>
      <div class="station">{{ station_name }}</div>
    </div>

    <div class="icon" style="font-size: 80px">‚õî</div>

    <div class="status-badge status-error">MEAL DENIED</div>

    <div class="message" style="margin-top: 20px">
      <strong id="student-name">Student</strong><br />
      <span id="denial-reason" style="color: #ef4444">Transaction denied</span>
    </div>

    <div
      class="student-info"
      style="
        margin-top: 20px;
        background: #fee2e2;
        padding: 20px;
        border-radius: 12px;
      "
    >
      <div class="detail">
        <span>Reason:</span>
        <strong id="reason-text" style="color: #dc2626; font-size: 20px"
          >---</strong
        >
      </div>
    </div>

    <div style="margin-top: 20px; font-size: 16px; color: #6b7280">
      Returning in <span id="countdown">2</span> seconds...
    </div>

    <div style="margin-top: 15px">
      <a href="/" class="btn btn-secondary" onclick="clearCountdown()"
        >‚Üê Return Now</a
      >
    </div>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const studentId = urlParams.get("student");

  if (studentId) {
    fetch("/api/manual-lookup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ student_id: studentId }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          document.getElementById("student-name").textContent =
            data.student.student_name;

          if (!data.eligibility.eligible) {
            document.getElementById("denial-reason").textContent =
              data.eligibility.reason;
            document.getElementById("reason-text").textContent =
              data.eligibility.reason;
          }
        }
      });
  }

  // Auto-redirect countdown (2 seconds)
  let timeLeft = 2;
  const countdownInterval = setInterval(() => {
    timeLeft--;
    const countdownEl = document.getElementById("countdown");
    if (countdownEl) {
      countdownEl.textContent = timeLeft;
    }

    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
      window.location.href = "/";
    }
  }, 1000);

  window.currentCountdown = countdownInterval;

  function clearCountdown() {
    if (window.currentCountdown) {
      clearInterval(window.currentCountdown);
    }
  }
</script>
{% endblock %}
